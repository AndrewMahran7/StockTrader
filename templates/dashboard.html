<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width        .trade-row {
            display: grid;
            grid-template-columns: 0.8fr 0.1fr 0.7fr 0.8fr 0.8fr 0.8fr 0.8fr 1.2fr;
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
            font-size: 0.85rem;
        }
        
        /* Candlestick table styles removed - now using integrated ORB chart */
        
        .price-up {
            color: #10b981;
        }
        
        .price-down {
            color: #ef4444;
        }
        
        .price-neutral {
            color: #94a3b8;
        }
        
        .volume-cell {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        
        .trade-row a {
            color: #60a5fa !important;
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s ease;
        }
        
        .trade-row a:hover {
            color: #10b981 !important;
            text-decoration: underline;
        }
        
        .trades-table .trade-row a {
            color: #60a5fa !important;
        }
        
        .trades-table .trade-row a:hover {
            color: #10b981 !important;
        }al-scale=1.0">
    <title>ORB Strategy Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 20px 0;
            border-bottom: 1px solid #334155;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
        }
        
        .metrics-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #334155;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .metric-sublabel {
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 2px;
        }
        
        .positive { color: #10b981; }
        .negative { color: #ef4444; }
        .neutral { color: #3b82f6; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .chart-section {
            background: #1e293b;
            border-radius: 10px;
            border: 1px solid #334155;
            padding: 20px;
        }
        
        .chart-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #e2e8f0;
        }
        
        .chart-container {
            height: 400px;
            width: 100%;
        }
        
        .stats-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .trades-table {
            background: #1e293b;
            border-radius: 10px;
            border: 1px solid #334155;
            overflow: hidden;
        }
        
        .table-header {
            background: #334155;
            padding: 15px;
            font-weight: bold;
        }
        
        .table-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .trade-row {
            display: grid;
            grid-template-columns: 0.8fr 0.7fr 0.7fr 0.8fr 0.8fr 0.8fr 1fr;
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
            font-size: 0.85rem;
        }
        
        .trade-row:nth-child(even) {
            background: #0f172a;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #94a3b8;
        }
        
        .error {
            color: #ef4444;
            text-align: center;
            padding: 20px;
        }
        
        .refresh-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .refresh-btn:hover {
            background: #059669;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-running { background: #10b981; color: white; }
        .status-stopped { background: #ef4444; color: white; }
        .status-waiting { background: #f59e0b; color: white; }
        
        .position-status {
            background: linear-gradient(135deg, #1e293b, #334155);
            border-radius: 10px;
            border: 1px solid #334155;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        
        .position-banner {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 30px;
            align-items: center;
        }
        
        .position-left, .position-right {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .position-center {
            text-align: center;
            border-left: 2px solid #475569;
            border-right: 2px solid #475569;
            padding: 0 30px;
        }
        
        .current-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #10b981;
            margin: 0;
        }
        
        .opening-range-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #e2e8f0;
        }
        
        .opening-range-levels {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .range-level {
            text-align: center;
        }
        
        .range-label {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 2px;
        }
        
        .range-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .position-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
        }
        
        .info-label {
            color: #94a3b8;
        }
        
        .info-value {
            font-weight: bold;
            color: #e2e8f0;
        }
        
        .position-long {
            border-left: 4px solid #10b981;
            padding-left: 15px;
        }
        
        .position-short {
            border-left: 4px solid #ef4444;
            padding-left: 15px;
        }
        
        .position-none {
            border-left: 4px solid #94a3b8;
            padding-left: 15px;
        }
        
        .entry-trigger {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 5px 0;
        }
        
        .trigger-label {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        
        .trigger-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .distance-info {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 2px;
        }
        
        .deposit-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        .deposit-btn:hover {
            background: #2563eb;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e293b, #334155);
            margin: 10% auto;
            padding: 30px;
            border: 1px solid #475569;
            border-radius: 10px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #e2e8f0;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-input {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 5px;
            color: #e2e8f0;
            font-size: 1rem;
            margin-top: 10px;
        }
        
        .modal-label {
            color: #94a3b8;
            font-size: 0.9rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .modal-btn-primary {
            background: #10b981;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #059669;
        }
        
        .modal-btn-secondary {
            background: #475569;
            color: white;
        }
        
        .modal-btn-secondary:hover {
            background: #334155;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">TSLA ORB Strategy Dashboard</div>
                <div>
                    <button class="deposit-btn" onclick="openDepositModal()">ðŸ’° Add Deposit</button>
                    <button class="refresh-btn" onclick="refreshDashboard()">Refresh Data</button>
                    <span id="lastUpdate" class="metric-label" style="margin-left: 15px;"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Position Status Banner -->
        <div class="position-status" id="positionStatus">
            <div class="loading">Loading position status...</div>
        </div>

        <!-- KPI Summary -->
        <div class="metrics-summary" id="metricsGrid">
            <div class="loading">Loading metrics...</div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Left Column - Charts -->
            <div>
                <!-- Equity Curve -->
                <div class="chart-section">
                    <h3 class="chart-title">Equity Curve vs Buy & Hold</h3>
                    <div id="equityChart" class="chart-container"></div>
                </div>
                
                <!-- Drawdown Chart -->
                <div class="chart-section" style="margin-top: 20px;">
                    <h3 class="chart-title">Running Drawdown</h3>
                    <div id="drawdownChart" class="chart-container"></div>
                </div>
                
                <!-- ORB Strategy Visualization -->
                <div class="chart-section" style="margin-top: 20px;">
                    <h3 class="chart-title">TSLA ORB Strategy Levels</h3>
                    <div id="orbChart" class="chart-container"></div>
                </div>
                
                <!-- Trade Returns Distribution -->
                <div class="chart-section" style="margin-top: 20px;">
                    <h3 class="chart-title">Trade Returns Distribution</h3>
                    <div id="returnsChart" class="chart-container"></div>
                </div>
            </div>
            
            <!-- Right Column - Stats -->
            <div class="stats-section">
                <!-- Win/Loss Pie Chart -->
                <div class="chart-section">
                    <h3 class="chart-title">Win/Loss Breakdown</h3>
                    <div id="winLossChart" class="chart-container" style="height: 250px;"></div>
                </div>
                
                <!-- Recent Trades Table -->
                <div class="trades-table">
                    <div class="table-header">Recent Trades</div>
                    <div class="table-body">
                        <!-- Table Headers -->
                        <div class="trade-row" style="background: #334155; font-weight: bold; border-bottom: 2px solid #475569;">
                            <div>Symbol</div>
                            <div>|</div>
                            <div>Date</div>
                            <div>Shares</div>
                            <div>Entry</div>
                            <div>Cost</div>
                            <div>Exit</div>
                            <div>P&L</div>
                        </div>
                        <div id="tradesTableBody">
                            <div class="loading">Loading trades...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Candlestick data now integrated in ORB chart above -->
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div id="depositModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add Deposit</div>
            <div class="modal-body">
                <label class="modal-label">Deposit Amount ($)</label>
                <input type="number" id="depositAmount" class="modal-input" placeholder="Enter amount (e.g., 1000)" step="0.01" min="0">
                <div class="modal-label" style="margin-top: 15px; font-size: 0.85rem; color: #64748b;">
                    This will be logged as a deposit transaction and included in your account balance calculation.
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeDepositModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="submitDeposit()">Add Deposit</button>
            </div>
        </div>
    </div>

    <script>
        // Global configuration
        const config = {
            displayModeBar: false,
            responsive: true
        };

        const layout_dark = {
            plot_bgcolor: '#0f172a',
            paper_bgcolor: '#1e293b',
            font: { color: '#e2e8f0', family: 'Segoe UI' },
            margin: { l: 40, r: 40, t: 40, b: 40 },
            xaxis: { gridcolor: '#334155', zeroline: false },
            yaxis: { gridcolor: '#334155', zeroline: false }
        };

        // Load and display position status
        async function loadPositionStatus() {
            try {
                const response = await fetch('/position_status');
                const data = await response.json();
                
                const statusElement = document.getElementById('positionStatus');
                
                if (data.error) {
                    statusElement.innerHTML = `<div class="error">Error loading position: ${data.error}</div>`;
                    return;
                }
                
                let positionHTML = '';
                
                if (data.has_position) {
                    // We have a position
                    const pos = data.position_details;
                    const side = pos.side;
                    const sideClass = side === 'Long' ? 'position-long' : 'position-short';
                    
                    positionHTML = `
                        <div class="position-banner">
                            <div class="position-left ${sideClass}">
                                <div class="opening-range-title">ðŸ”¥ ${side} Position Active</div>
                                <div class="position-info">
                                    <div class="info-row">
                                        <span class="info-label">Shares:</span>
                                        <span class="info-value">${Math.abs(pos.shares)} TSLA</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Entry Price:</span>
                                        <span class="info-value">$${pos.entry_price.toFixed(2)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Current Value:</span>
                                        <span class="info-value">$${pos.current_value.toFixed(2)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Unrealized P&L:</span>
                                        <span class="info-value ${pos.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                                            $${pos.unrealized_pnl.toFixed(2)} (${pos.unrealized_pnl_percent.toFixed(1)}%)
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="position-center">
                                <div class="current-price">$${data.current_price.toFixed(2)}</div>
                                <div class="metric-label">Current TSLA Price</div>
                                ${data.opening_range && data.opening_range.high ? `
                                    <div style="margin-top: 15px;">
                                        <div class="opening-range-title">15-Min Opening Range</div>
                                        <div class="opening-range-levels">
                                            <div class="range-level">
                                                <div class="range-label">High</div>
                                                <div class="range-value">$${data.opening_range.high.toFixed(2)}</div>
                                            </div>
                                            <div class="range-level">
                                                <div class="range-label">Low</div>
                                                <div class="range-value">$${data.opening_range.low.toFixed(2)}</div>
                                            </div>
                                            <div class="range-level">
                                                <div class="range-label">Range</div>
                                                <div class="range-value">$${data.opening_range.range.toFixed(2)}</div>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="position-right">
                                <div class="opening-range-title">ðŸŽ¯ Exit Strategy</div>
                                <div class="position-info">
                                    <div class="info-row">
                                        <span class="info-label">Target Price:</span>
                                        <span class="info-value positive">$${pos.target_price.toFixed(2)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Distance to Target:</span>
                                        <span class="info-value">${pos.distance_to_target.toFixed(2)} pts</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Stop Loss:</span>
                                        <span class="info-value negative">$${pos.stop_loss.toFixed(2)}</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Distance to Stop:</span>
                                        <span class="info-value">${pos.distance_to_stop.toFixed(2)} pts</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Risk/Reward:</span>
                                        <span class="info-value">${pos.risk_reward_ratio.toFixed(2)}:1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // No position - show entry triggers
                    const triggers = data.entry_signals;
                    
                    positionHTML = `
                        <div class="position-banner">
                            <div class="position-left position-none">
                                <div class="opening-range-title">ðŸ“Š No Current Position</div>
                                <div class="position-info">
                                    <div class="info-row">
                                        <span class="info-label">TSLA Shares:</span>
                                        <span class="info-value">0</span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Strategy:</span>
                                        <span class="info-value">${data.strategy_status}</span>
                                    </div>
                                </div>
                                ${triggers && triggers.long_trigger ? `
                                    <div class="entry-trigger">
                                        <div class="trigger-label">ðŸš€ Long Entry Trigger</div>
                                        <div class="trigger-value">$${triggers.long_trigger.toFixed(2)}</div>
                                        <div class="distance-info">
                                            ${triggers.distance_to_long_trigger > 0 
                                                ? `Need +$${triggers.distance_to_long_trigger.toFixed(2)} to trigger`
                                                : `Ready to trigger (above OR high)`
                                            }
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="position-center">
                                <div class="current-price">$${data.current_price.toFixed(2)}</div>
                                <div class="metric-label">Current TSLA Price</div>
                                ${data.opening_range && data.opening_range.high ? `
                                    <div style="margin-top: 15px;">
                                        <div class="opening-range-title">15-Min Opening Range</div>
                                        <div class="opening-range-levels">
                                            <div class="range-level">
                                                <div class="range-label">High (Long Entry)</div>
                                                <div class="range-value">$${data.opening_range.high.toFixed(2)}</div>
                                            </div>
                                            <div class="range-level">
                                                <div class="range-label">Low (Short Entry)</div>
                                                <div class="range-value">$${data.opening_range.low.toFixed(2)}</div>
                                            </div>
                                            <div class="range-level">
                                                <div class="range-label">Range Size</div>
                                                <div class="range-value">$${data.opening_range.range.toFixed(2)}</div>
                                            </div>
                                        </div>
                                    </div>
                                ` : '<div style="margin-top: 15px; color: #94a3b8;">Opening Range Not Set</div>'}
                            </div>
                            
                            <div class="position-right">
                                <div class="opening-range-title">ðŸ“ˆ Entry Levels</div>
                                ${triggers && triggers.short_trigger ? `
                                    <div class="entry-trigger">
                                        <div class="trigger-label">ðŸ“‰ Short Entry Trigger</div>
                                        <div class="trigger-value">$${triggers.short_trigger.toFixed(2)}</div>
                                        <div class="distance-info">
                                            ${triggers.distance_to_short_trigger > 0 
                                                ? `Need -$${triggers.distance_to_short_trigger.toFixed(2)} to trigger`
                                                : `Ready to trigger (below OR low)`
                                            }
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 0.85rem; color: #94a3b8;">
                                        <div>Long Target: $${triggers.long_target ? triggers.long_target.toFixed(2) : 'N/A'}</div>
                                        <div>Short Target: $${triggers.short_target ? triggers.short_target.toFixed(2) : 'N/A'}</div>
                                    </div>
                                ` : '<div class="info-value">Waiting for opening range...</div>'}
                            </div>
                        </div>
                    `;
                }
                
                statusElement.innerHTML = positionHTML;
                
            } catch (error) {
                document.getElementById('positionStatus').innerHTML = 
                    `<div class="error">Error loading position status: ${error.message}</div>`;
            }
        }

        // Fetch and display metrics
        async function loadMetrics() {
            try {
                const response = await fetch('/metrics');
                const metrics = await response.json();
                
                const grid = document.getElementById('metricsGrid');
                
                if (metrics.error) {
                    grid.innerHTML = `<div class="error">Error loading metrics: ${metrics.error}</div>`;
                    return;
                }
                
                grid.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value ${(metrics.realized_pnl || 0) >= 0 ? 'positive' : 'negative'}">
                            $${(metrics.realized_pnl || 0).toFixed(2)}
                        </div>
                        <div class="metric-label">Realized P&L</div>
                        <div class="metric-sublabel ${(metrics.unrealized_pnl || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(metrics.unrealized_pnl || 0) >= 0 ? '+' : ''}$${Math.abs(metrics.unrealized_pnl || 0).toFixed(2)} unrealized
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value neutral">
                            $${(metrics.account_balance || 1000).toFixed(2)}
                        </div>
                        <div class="metric-label">Account Balance</div>
                        <div class="metric-sublabel ${(metrics.total_pnl_percent || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(metrics.total_pnl_percent || 0) >= 0 ? '+' : ''}${(metrics.total_pnl_percent || 0).toFixed(2)}% total gain
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${(metrics.win_rate || 0) >= 50 ? 'positive' : 'negative'}">
                            ${(metrics.win_rate || 0).toFixed(1)}%
                        </div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${(metrics.profit_factor || 0) >= 1 ? 'positive' : 'negative'}">
                            ${(metrics.profit_factor || 0).toFixed(2)}
                        </div>
                        <div class="metric-label">Profit Factor</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value negative">
                            ${(metrics.max_drawdown || 0).toFixed(2)}%
                        </div>
                        <div class="metric-label">Max Drawdown</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value neutral">
                            ${metrics.total_trades || 0}
                        </div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${(metrics.sharpe_ratio || 0) >= 1 ? 'positive' : 'negative'}">
                            ${(metrics.sharpe_ratio || 0).toFixed(2)}
                        </div>
                        <div class="metric-label">Sharpe Ratio</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value neutral">
                            $${(metrics.current_tsla_price || 395.94).toFixed(2)}
                        </div>
                        <div class="metric-label">TSLA Price</div>
                        <div class="metric-sublabel ${(metrics.tsla_change_percent || 0) >= 0 ? 'positive' : 'negative'}">
                            ${(metrics.tsla_change_percent || 0) >= 0 ? '+' : ''}${(metrics.tsla_change_percent || 0).toFixed(1)}% from start
                        </div>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('metricsGrid').innerHTML = 
                    `<div class="error">Error loading metrics: ${error.message}</div>`;
            }
        }

        // Load and display equity curve
        async function loadEquityCurve() {
            try {
                const response = await fetch('/equity');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('equityChart').innerHTML = 
                        `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                const traces = [
                    {
                        x: data.dates,
                        y: data.strategy_equity,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'ORB Strategy',
                        line: { color: '#10b981', width: 2 }
                    },
                    {
                        x: data.dates,
                        y: data.buyhold_equity,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Buy & Hold',
                        line: { color: '#3b82f6', width: 2 }
                    }
                ];
                
                const layout = {
                    ...layout_dark,
                    title: '',
                    showlegend: true,
                    legend: { x: 0.02, y: 0.98 }
                };
                
                Plotly.newPlot('equityChart', traces, layout, config);
                
            } catch (error) {
                document.getElementById('equityChart').innerHTML = 
                    `<div class="error">Error loading equity data: ${error.message}</div>`;
            }
        }

        // Load and display drawdown chart
        async function loadDrawdownChart() {
            try {
                const response = await fetch('/equity');
                const data = await response.json();
                
                if (data.error || !data.drawdown) {
                    return;
                }
                
                const trace = {
                    x: data.dates,
                    y: data.drawdown,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Drawdown',
                    fill: 'tozeroy',
                    fillcolor: 'rgba(239, 68, 68, 0.3)',
                    line: { color: '#ef4444', width: 2 }
                };
                
                const layout = {
                    ...layout_dark,
                    title: '',
                    yaxis: { 
                        ...layout_dark.yaxis,
                        tickformat: '.1%',
                        range: [Math.min(...data.drawdown) * 1.1, 0.05]
                    }
                };
                
                Plotly.newPlot('drawdownChart', [trace], layout, config);
                
            } catch (error) {
                console.error('Error loading drawdown chart:', error);
            }
        }

        // Load ORB strategy visualization
        async function loadORBChart() {
            try {
                const response = await fetch('/chart-data');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('orbChart').innerHTML = 
                        `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                if (!data.price_data || data.price_data.length === 0) {
                    document.getElementById('orbChart').innerHTML = 
                        '<div class="loading">No price data available</div>';
                    return;
                }
                
                // Create 1-minute OHLC candlestick chart
                const traces = [{
                    x: data.price_data.map(d => d.time || d.date),
                    open: data.price_data.map(d => d.open),
                    high: data.price_data.map(d => d.high),
                    low: data.price_data.map(d => d.low),
                    close: data.price_data.map(d => d.close),
                    type: 'candlestick',
                    name: 'TSLA 1min',
                    increasing: { 
                        line: { color: '#10b981', width: 1 },
                        fillcolor: 'rgba(16, 185, 129, 0.3)'
                    },
                    decreasing: { 
                        line: { color: '#ef4444', width: 1 },
                        fillcolor: 'rgba(239, 68, 68, 0.3)'
                    }
                }];
                
                // Add ORB levels if available
                if (data.current_levels && data.current_levels.or_high) {
                    const levels = data.current_levels;
                    const timeAxis = data.price_data.map(d => d.time || d.date);
                    
                    // Opening Range High (breakout level) - Bold blue line
                    traces.push({
                        x: timeAxis,
                        y: Array(timeAxis.length).fill(levels.or_high),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'OR High (Long Entry)',
                        line: { color: '#3b82f6', width: 3, dash: 'solid' }
                    });
                    
                    // Opening Range Low (breakout level) - Bold blue line
                    traces.push({
                        x: timeAxis,
                        y: Array(timeAxis.length).fill(levels.or_low),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'OR Low (Short Entry)',
                        line: { color: '#3b82f6', width: 3, dash: 'solid' }
                    });
                    
                    // Target levels (2:1 reward-to-risk) - Green dashed
                    traces.push({
                        x: timeAxis,
                        y: Array(timeAxis.length).fill(levels.target_high),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Long Target (2:1)',
                        line: { color: '#10b981', width: 2, dash: 'dash' }
                    });
                    
                    traces.push({
                        x: timeAxis,
                        y: Array(timeAxis.length).fill(levels.target_low),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Short Target (2:1)',
                        line: { color: '#10b981', width: 2, dash: 'dash' }
                    });
                    
                    // Stop loss levels - Red dotted
                    traces.push({
                        x: timeAxis,
                        y: Array(timeAxis.length).fill(levels.stop_high),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Long Stop Loss',
                        line: { color: '#ef4444', width: 2, dash: 'dot' }
                    });
                    
                    traces.push({
                        x: timeAxis,
                        y: Array(timeAxis.length).fill(levels.stop_low),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Short Stop Loss',
                        line: { color: '#ef4444', width: 2, dash: 'dot' }
                    });
                    
                    // Current position entry (if active) - Bold orange line
                    if (levels.entry_price && levels.position_side) {
                        traces.push({
                            x: timeAxis,
                            y: Array(timeAxis.length).fill(levels.entry_price),
                            type: 'scatter',
                            mode: 'lines',
                            name: `ðŸ”¥ ${levels.position_side} Entry: $${levels.entry_price.toFixed(2)}`,
                            line: { color: '#f59e0b', width: 4, dash: 'solid' }
                        });
                        
                        // Add take profit line if available
                        if (levels.take_profit) {
                            traces.push({
                                x: timeAxis,
                                y: Array(timeAxis.length).fill(levels.take_profit),
                                type: 'scatter',
                                mode: 'lines',
                                name: `ðŸŽ¯ Take Profit: $${levels.take_profit.toFixed(2)}`,
                                line: { color: '#10b981', width: 3, dash: 'solid' }
                            });
                        }
                        
                        // Add stop loss line if available
                        if (levels.stop_loss) {
                            traces.push({
                                x: timeAxis,
                                y: Array(timeAxis.length).fill(levels.stop_loss),
                                type: 'scatter',
                                mode: 'lines',
                                name: `ðŸ›‘ Stop Loss: $${levels.stop_loss.toFixed(2)}`,
                                line: { color: '#ef4444', width: 3, dash: 'solid' }
                            });
                        }
                    }
                }
                
                // Add trade markers - align with candlestick times
                if (data.trades && data.trades.length > 0) {
                    const buyTrades = data.trades.filter(t => t.action === 'buy');
                    const sellTrades = data.trades.filter(t => t.action === 'sell');
                    
                    if (buyTrades.length > 0) {
                        traces.push({
                            x: buyTrades.map(t => t.time),  // Use time to match candlestick x-axis
                            y: buyTrades.map(t => t.price),
                            type: 'scatter',
                            mode: 'markers',
                            name: 'Buy Orders',
                            marker: { 
                                color: '#10b981', 
                                size: 14, 
                                symbol: 'triangle-up',
                                line: { color: 'white', width: 2 }
                            }
                        });
                    }
                    
                    if (sellTrades.length > 0) {
                        traces.push({
                            x: sellTrades.map(t => t.time),  // Use time to match candlestick x-axis
                            y: sellTrades.map(t => t.price),
                            type: 'scatter',
                            mode: 'markers',
                            name: 'Sell Orders',
                            marker: { 
                                color: '#ef4444', 
                                size: 14, 
                                symbol: 'triangle-down',
                                line: { color: 'white', width: 2 }
                            }
                        });
                    }
                }
                
                const layout = {
                    ...layout_dark,
                    title: '',
                    showlegend: true,
                    legend: { x: 0.02, y: 0.98, bgcolor: 'rgba(0,0,0,0)' },
                    yaxis: { 
                        ...layout_dark.yaxis, 
                        title: 'Price ($)',
                        fixedrange: false,
                        autorange: true,
                        rangemode: 'normal'
                    },
                    xaxis: { 
                        ...layout_dark.xaxis,
                        rangeslider: { visible: false },
                        type: 'category',
                        autorange: true,
                        categoryorder: 'array',
                        categoryarray: data.price_data.map(d => d.time || d.date)
                    },
                    margin: { l: 60, r: 40, t: 20, b: 60 }
                };
                
                Plotly.newPlot('orbChart', traces, layout, {
                    ...config,
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                });
                
            } catch (error) {
                console.error('Error loading ORB chart:', error);
                document.getElementById('orbChart').innerHTML = 
                    `<div class="error">Error loading ORB chart: ${error.message}</div>`;
            }
        }

        // Load returns distribution
        async function loadReturnsChart() {
            try {
                const response = await fetch('/trades_table');
                const data = await response.json();
                
                if (data.error || !data.trades || data.trades.length === 0) {
                    return;
                }
                
                // Filter out invalid trades and calculate returns
                const validTrades = data.trades.filter(trade => 
                    trade.pnl !== null && 
                    trade.pnl !== undefined && 
                    trade.entry_price && 
                    trade.entry_price > 0
                );
                
                if (validTrades.length === 0) {
                    console.log('No valid trades for returns chart');
                    return;
                }
                
                const returns = validTrades.map(trade => 
                    (trade.pnl / Math.abs(trade.entry_price * trade.quantity)) * 100
                );
                
                const trace = {
                    x: returns,
                    type: 'histogram',
                    nbinsx: Math.max(10, Math.min(20, returns.length / 2)),
                    marker: { 
                        color: returns.map(r => r >= 0 ? '#10b981' : '#ef4444'),
                        opacity: 0.7 
                    },
                    name: 'Trade Returns'
                };
                
                const layout = {
                    ...layout_dark,
                    title: '',
                    xaxis: { ...layout_dark.xaxis, title: 'Return (%)' },
                    yaxis: { ...layout_dark.yaxis, title: 'Frequency' }
                };
                
                Plotly.newPlot('returnsChart', [trace], layout, config);
                
            } catch (error) {
                console.error('Error loading returns chart:', error);
            }
        }

        // Load win/loss pie chart
        async function loadWinLossChart() {
            try {
                const response = await fetch('/trades_table');
                const data = await response.json();
                
                if (data.error || !data.trades || data.trades.length === 0) {
                    document.getElementById('winLossChart').innerHTML = 
                        '<div class="loading">No trades data</div>';
                    return;
                }
                
                const wins = data.trades.filter(trade => trade.pnl > 0).length;
                const losses = data.trades.filter(trade => trade.pnl <= 0).length;
                
                const trace = {
                    values: [wins, losses],
                    labels: ['Wins', 'Losses'],
                    type: 'pie',
                    marker: {
                        colors: ['#10b981', '#ef4444']
                    },
                    textinfo: 'label+percent',
                    textfont: { color: '#e2e8f0' }
                };
                
                const layout = {
                    ...layout_dark,
                    title: '',
                    showlegend: false,
                    margin: { l: 20, r: 20, t: 20, b: 20 }
                };
                
                Plotly.newPlot('winLossChart', [trace], layout, config);
                
            } catch (error) {
                console.error('Error loading win/loss chart:', error);
            }
        }

        // Load recent trades table
        async function loadTradesTable() {
            try {
                const response = await fetch('/trades_table');
                const data = await response.json();
                
                const tableBody = document.getElementById('tradesTableBody');
                
                if (data.error) {
                    tableBody.innerHTML = `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                if (!data.trades || data.trades.length === 0) {
                    tableBody.innerHTML = '<div class="loading">No trades yet</div>';
                    return;
                }
                
                const recentTrades = data.trades.slice(-10).reverse(); // Last 10 trades
                
                tableBody.innerHTML = recentTrades.map(trade => {
                    const totalCost = (trade.entry_price || trade.price) * (trade.quantity || 0);
                    const shares = trade.quantity || 0;
                    const symbol = trade.ticker || 'N/A';
                    
                    let tradeDate = 'N/A';
                    try {
                        const dateValue = trade.entry_time || trade.timestamp;
                        if (dateValue && dateValue !== '') {
                            if (typeof dateValue === 'string') {
                                const isoString = dateValue.includes(' ') ? dateValue.replace(' ', 'T') : dateValue;
                                const parsedDate = new Date(isoString);
                                if (!isNaN(parsedDate.getTime()) && parsedDate.getFullYear() > 2020) {
                                    tradeDate = parsedDate.toLocaleDateString();
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Date parsing error:', e);
                        tradeDate = 'N/A';
                    }
                    
                    return `
                        <div class="trade-row">
                            <div><a href="https://finance.yahoo.com/quote/${symbol}/" target="_blank">${symbol}</a></div>
                            <div style="text-align: center; color: #475569;">|</div>
                            <div>${tradeDate}</div>
                            <div>${shares >= 1 ? shares.toFixed(0) : shares.toFixed(4)}</div>
                            <div>$${(trade.entry_price || trade.price).toFixed(2)}</div>
                            <div>$${totalCost.toFixed(2)}</div>
                            <div>$${trade.exit_price ? trade.exit_price.toFixed(2) : 'Open'}</div>
                            <div class="${trade.pnl >= 0 ? 'positive' : 'negative'}">
                                $${trade.pnl ? trade.pnl.toFixed(2) : 'N/A'}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                document.getElementById('tradesTableBody').innerHTML = 
                    `<div class="error">Error loading trades: ${error.message}</div>`;
            }
        }

        // Note: 1-minute candlestick data is now integrated directly in the ORB chart above

        // Refresh all dashboard data
        async function refreshDashboard() {
            document.getElementById('lastUpdate').textContent = 'Refreshing...';
            
            try {
                await Promise.all([
                    loadPositionStatus(),  // Load position status first
                    loadMetrics(),
                    loadEquityCurve(),
                    loadDrawdownChart(),
                    loadORBChart(),
                    loadReturnsChart(),
                    loadWinLossChart(),
                    loadTradesTable()
                ]);
                
                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                document.getElementById('lastUpdate').textContent = 'Error updating';
                console.error('Dashboard refresh error:', error);
            }
        }

        // Deposit modal functions
        function openDepositModal() {
            document.getElementById('depositModal').style.display = 'block';
            document.getElementById('depositAmount').value = '';
            document.getElementById('depositAmount').focus();
        }
        
        function closeDepositModal() {
            document.getElementById('depositModal').style.display = 'none';
        }
        
        async function submitDeposit() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid deposit amount');
                return;
            }
            
            try {
                const response = await fetch('/add_deposit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ amount: amount })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Deposit of $${amount.toFixed(2)} added successfully!`);
                    closeDepositModal();
                    refreshDashboard();
                } else {
                    alert(`Error: ${result.error || 'Failed to add deposit'}`);
                }
            } catch (error) {
                alert(`Error adding deposit: ${error.message}`);
            }
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('depositModal');
            if (event.target == modal) {
                closeDepositModal();
            }
        }
        
        // Allow Enter key to submit in deposit modal
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('depositAmount').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    submitDeposit();
                }
            });
        });

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            refreshDashboard();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshDashboard, 30000);
        });
    </script>
</body>
</html>
